---
layout:     post
title:	MYSQL专题
subtitle: 	事务管理机制
date:       2019-12-13
author:     chuangkel
header-img: img/post-bg-ios9-web.jpg
catalog: true
tags:
    - 数据库
---

# 事务管理机制

### 事务特性

> ACID事务四大特性：原子性（atomicity)、一致性（consistency)、隔离性（isolation)、和持久性（durability)。

* 原子性（atomicity)：一个事务不可再分割，要么全部执行，要么不执行，不存在中间状态。
* 一致性（consistency)：业务的一致性，如A向B转账，事务执行前后，AB总的金额是一致的。数据库一致性，事务不会影响数据库的一致性，如外键约束，唯一索引，check约束和触发器设置，事务执行前后一致。
* 隔离性（isolation)：多个事务之间并发操作数据库，事务之间隔离。事务最复杂的问题都是有隔离性引起的，如事务的隔离级别。
* 持久性（durability) ：数据持久化的数据库中。

### 事务隔离级别有哪四种？

* 未提交读（RU Read Uncommitted）：允许脏读。事务A未提交之前，事务B读取事务A操作数据库的数据。
* 提交读（RC Read Committed）：允许不可重复读，解决脏读。
* 可重复读(RR Read Repeated )：允许幻读，解决不可重复读。innodb_locks_unsafe_for_binlog开启的条件下（InnoDb的多版本并发控制），可以解决幻读问题。(可重复读是mysql的默认事务隔离级别)
* 串行化读(RS Read Serializable）：在读取每一行中都加上行锁。解决了事务的脏读，不可重复读，幻读问题。但是成本较高。

### 事务隔离级别之间的三种问题？

* 脏读：A事务修改的数据未提交，B事务读取了A事务的未提交的数据。
* 不可重复读：针对的是同一条或固定几条数据。A事务两次对同一条或固定几条数据进行读取之间，B事务对A事务读取的数据进行了修改，导致A事务两次读取的数据不一致（修改的是行内数据）。
* 幻读：事务A两次范围查询之间，事务B在A查询的范围中进行增加或者删除某行或几行，导致A事务第二次读取和第一次读取的数据不一致。（增加或删除整行数据）

| 事务隔离级别\问题 | 脏读   | 不可重复读       | 幻读   | 加锁读 |
| ----------------- | ------ | ---------------- | ------ | ------ |
| 未提交读(R U)     | 允许   | 允许             | 允许   | no     |
| 提交读(R C)       | 不允许 | 允许             | 允许   | no     |
| 可重复读(R R)     | 不允许 | 不允许(默认情况) | 允许   | no     |
| 串行化读(R S)     | 不允许 | 不允许           | 不允许 | yes    |

> \* 这是通常情况下，不排除特殊情况。比如innodb_locks_unsafe_for_binlog开启的情况下，可重复读可以解决幻读的问题。

### innodb_locks_unsafe_for_binlog是什么？

> innodb_locks_unsafe_for_binlog默认为off





### 多版本并发控制 

> MVCC，Multi-Version Concurrency Control，多版本并发控制。MVCC 是一种并发控制的方法，一般在数据库管理系统中，实现对数据库的并发访问；在编程语言中实现事务内存。



| mysql中，A事务新增修改未提交，B事务进行读取A事务修改的表，只能读取到该表最新的版本的数据，待A事务提交之后方可读取A事务的数据。（默认隔离级别：可重复读）



```sql
SELECT @@tx_isolation; //查看数据库隔离级别，默认RR
```

### 怎么加索引？

* 查询概率比较高的表
* 从查询条件看，where条件十分频繁的列加唯一索引或组合索引。





B+树

### 幻读产生的问题？

> A事务查询之后没有key_1,准备插入，但是在A事务查询之后插入之前，B事务插入了主键为key_1的行，则B事务会报Duplicate entry。注：瑜伽TA里面报过主键冲突Duplicate entry ,是通过重试来解决的。

