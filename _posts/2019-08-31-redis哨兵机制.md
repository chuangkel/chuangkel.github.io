---
layout:     post
title:	redis哨兵机制
subtitle: 	redis哨兵机制
date:       2019-08-30
author:     chuangkel
header-img: img/post-bg-ios9-web.jpg
catalog: true
tags:
    - spring
---

# redis哨兵机制

Redis 集群（Redis Cluster）中内置了 16384（2^14次方）个哈希槽(hash slot)，一个哈希槽中会有很多key和value键值对，当需要在 Redis 集群中放置一个 key-value时，redis 先对 key 使用 crc16校验算法算出一个结果，然后把结果对 16384 求余数（取模），这样每个 key 都会对应一个编号在 0-16383 之间的哈希槽。redis 会根据节点数量大致均等的将哈希槽映射到不同的节点，集群的每个节点负责一部分hash槽。（取模后是怎么找到对应的节点的？动态增删节点的时候，怎么做到不丢失数据的？redis集群怎么实现数据共享？）

Redis 集群为什么没有使用一致性hash？而是引入了哈希槽的概念，如果使用一致性hash，在新增节点或者删除节点都会导致大面积缓存找不到，造成缓存击穿。

- redis cluster 是 redis 提供的分布式数据库方案，通过在多个 redis 节点之间分片(sharding)来进行数据共享。并能在部分节点故障的情况下继续运行。
- redis 集群的基本存储单位是槽（slot），一个集群有2^14=16384个槽。每一个槽的key存放在集群中的唯一一个master节点中，每一个槽还有0~N个slave节点。

![1567063895702](/../img/1567063895702.png)

#### 哨兵进程的作用

* 监控(Monitoring)：哨兵(sentinel) 会不断地检查你的 Master 和 Slave 是否运作正常。

* 提醒(Notification)：当被监控的某个Redis节点出现问题时, 哨兵(sentinel) 可以通过 API 向管理员或者其他应用程序发送通知。

* 自动故障迁移(Automatic failover)：当一个 Master 不能正常工作时，哨兵(sentinel) 会开始一次自动故障迁移操作。具体操作如下：
  * 它会将失效 Master 的其中一个 Slave 升级为新的 Master, 并让失效 Master 的其他Slave 改为复制新的 Master。
  * 当客户端试图连接失效的 Master 时，集群也会向客户端返回新 Master 的地址，使得集群可以使用现在的 Master 替换失效 Master。
  * Master 和 Slave 服务器切换后，Master 的 redis.conf、Slave 的 redis.conf 和sentinel.conf 的配置文件的内容都会发生相应的改变，即 Master 主服务器的 redis.conf 配置文件中会多一行 slaveof 的配置，sentinel.conf 的监控目标会随之调换。



#### 哨兵进程的工作方式

> 在一般情况下， 每个 Sentinel（哨兵）进程会以每 10 秒一次的频率向集群中的所有Master 主服务器、Slave 从服务器发送 INFO 命令。

* 每个 Sentinel（哨兵）进程以每秒钟一次的频率向整个集群中的 Master 主服务器，Slave 从服务器以及其他 Sentinel（哨兵）进程发送一个 PING 命令。
* 如果一个实例（instance）距离最后一次有效回复 PING 命令的时间超过 down-after-milliseconds 选项所指定的值， 则这个实例会被 Sentinel（哨兵）进程标记为主观下线（SDOWN）。
* 如果一个 Master 主服务器被标记为主观下线（SDOWN），则正在监视这个 Master 主服务器的所有 Sentinel（哨兵）进程要以每秒一次的频率确认 Master 主服务器的确进入了主观下线状态。
* 当有足够数量的 Sentinel（哨兵）进程（大于等于配置文件指定的值）在指定的时间范围内确认 Master 主服务器进入了主观下线状态（SDOWN）， 则 Master 主服务器会被标记为客观下线（ODOWN）。
* 当 Master 主服务器被 Sentinel（哨兵）进程标记为客观下线（ODOWN）时，Sentinel（哨兵）进程向下线的 Master 主服务器的所有 Slave 从服务器发送 INFO 命令的频率会从 10 秒一次改为每秒一次。
* 若没有足够数量的 Sentinel（哨兵）进程同意 Master 主服务器下线， Master 主服务器的客观下线状态就会被移除。若 Master 主服务器重新向 Sentinel（哨兵）进程发送 PING 命令返回有效回复，Master 主服务器的主观下线状态就会被移除。

#### redis是怎么保证一致性的？





扩展：

* Cyclic Redundancy Check循环冗余检验，是基于数据计算一组效验码，用于核对数据传输过程中是否被更改或传输错误
* 一致性hash算法：应用场景：图片存放到服务器，实现均衡存放，上线下线服务器之后不会阻塞请求。把服务器hash(ip) % 2^32散列到0~2^32次方上面（若数量太少散列得很集中，则可以增加虚拟节点）；每一个图片存储到哪个服务器呢？hash(img.png)%2^32顺时针找到第一台服务器存放。（为什么是2^32次方，在于hash值是int型，最大值为2^32-1）
* 解决hash冲突的方法
  * 再散列法
  * 开放寻址法：偏移
    * 线性探测再散列，二次探测在散列，随机探测再散列
  * 链地址法：在原地形成链表

