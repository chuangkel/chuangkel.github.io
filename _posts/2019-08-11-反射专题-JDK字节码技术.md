---
layout:     post
title:	java反射和代理
subtitle: 	JDK字节码技术
date:       2019-08-11
author:     chuangkel
header-img: img/post-bg-ios9-web.jpg
catalog: true
tags:
    - java
---

JDK字节码技术

**引用**

1. 为什么jdk动态代理不能代理类 只能代理实现接口的类？
2. 什么是静态代理



**分析**

1. 为什么jdk动态代理不能代理类 只能代理实现接口的类？

   jdk动态代理生成的代理类实现了被代理类的接口，默认继承了Proxy类，同时因为java只支持单继承，所以不能再对类进行代理。只能对接口进行代理。

   生成静态代码块初始化接口中的方法.  JDK动态代理除了代理接口中的方法,  还代理了Object 类中的 equals(), toString(), hashCode() 方法.

   代理类调用接口中的方法,  实际是调用了 InvocationHandler 中的 invoke() 方法. 从而实现了对接口的代理.

   

2. 什么是静态代理



## 生成接口代理类

测试使用的接口

```java
public interface Animal {
    void eat();
    void sport();
}
```

 ProxyGenerator.generateProxyClass(name,new Class[]{Animal.class})

```java
public static void main(String[] args) {
    String name = "GeneratedProxyClass";
    byte[] bytes = ProxyGenerator.generateProxyClass(name,new Class[]{Animal.class});
    try {
        FileOutputStream fos = new FileOutputStream(name+".class");
        fos.write(bytes);
    } catch (FileNotFoundException e) {
        e.printStackTrace();
    } catch (IOException e) {
        e.printStackTrace();
    }
}
```

生成的代理类如下：

```java
//
// Source code recreated from a .class file by IntelliJ IDEA
// (powered by Fernflower decompiler)
//

import com.github.chuangkel.java_learn.base.reflect.poxy.Animal;
import java.lang.reflect.InvocationHandler;
import java.lang.reflect.Method;
import java.lang.reflect.Proxy;
import java.lang.reflect.UndeclaredThrowableException;

public final class GeneratedProxyClass extends Proxy implements Animal {
    private static Method m1;
    private static Method m4;
    private static Method m2;
    private static Method m3;
    private static Method m0;

    public GeneratedProxyClass(InvocationHandler var1) throws  {
        super(var1);
    }

    public final boolean equals(Object var1) throws  {
        try {
            return (Boolean)super.h.invoke(this, m1, new Object[]{var1});
        } catch (RuntimeException | Error var3) {
            throw var3;
        } catch (Throwable var4) {
            throw new UndeclaredThrowableException(var4);
        }
    }

    public final void eat() throws  {
        try {
            super.h.invoke(this, m4, (Object[])null);
        } catch (RuntimeException | Error var2) {
            throw var2;
        } catch (Throwable var3) {
            throw new UndeclaredThrowableException(var3);
        }
    }

    public final String toString() throws  {
        try {
            return (String)super.h.invoke(this, m2, (Object[])null);
        } catch (RuntimeException | Error var2) {
            throw var2;
        } catch (Throwable var3) {
            throw new UndeclaredThrowableException(var3);
        }
    }

    public final void sport() throws  {
        try {
            super.h.invoke(this, m3, (Object[])null);
        } catch (RuntimeException | Error var2) {
            throw var2;
        } catch (Throwable var3) {
            throw new UndeclaredThrowableException(var3);
        }
    }

    public final int hashCode() throws  {
        try {
            return (Integer)super.h.invoke(this, m0, (Object[])null);
        } catch (RuntimeException | Error var2) {
            throw var2;
        } catch (Throwable var3) {
            throw new UndeclaredThrowableException(var3);
        }
    }

    static {
        try {
            m1 = Class.forName("java.lang.Object").getMethod("equals", Class.forName("java.lang.Object"));
            m4 = Class.forName("com.github.chuangkel.java_learn.base.reflect.poxy.Animal").getMethod("eat");
            m2 = Class.forName("java.lang.Object").getMethod("toString");
            m3 = Class.forName("com.github.chuangkel.java_learn.base.reflect.poxy.Animal").getMethod("sport");
            m0 = Class.forName("java.lang.Object").getMethod("hashCode");
        } catch (NoSuchMethodException var2) {
            throw new NoSuchMethodError(var2.getMessage());
        } catch (ClassNotFoundException var3) {
            throw new NoClassDefFoundError(var3.getMessage());
        }
    }
}
```

在生成的代理类中，以下时重点

```java
public final void eat() throws  {
    try {
        super.h.invoke(this, m4, (Object[])null); //这调用了invoke方法
    } catch (RuntimeException | Error var2) {
        throw var2;
    } catch (Throwable var3) {
        throw new UndeclaredThrowableException(var3);
    }
}
```

